"use client";

import { useState, useEffect, useRef, useCallback } from "react";
import { Play, Square, ChevronDown, Bot, Percent, DollarSign, AlertTriangle, Loader2 } from "lucide-react";
import type { SupportedAsset, BotLogEntry, LimitOrderBotResponse } from "@/types/betting-bot";

const ASSETS: { value: SupportedAsset; label: string; icon: string }[] = [
  { value: "BTC", label: "Bitcoin (BTC)", icon: "₿" },
  { value: "ETH", label: "Ethereum (ETH)", icon: "Ξ" },
  { value: "SOL", label: "Solana (SOL)", icon: "◎" },
  { value: "XRP", label: "Ripple (XRP)", icon: "✕" },
];

const PRICE_OPTIONS = [
  { value: 45, label: "45%" },
  { value: 46, label: "46%" },
  { value: 47, label: "47%" },
  { value: 48, label: "48% (Recommended)" },
  { value: 49, label: "49%" },
];

const POLL_INTERVAL_MS = 15 * 60 * 1000; // 15 minutes

/**
 * Get the next 15-minute market timestamp (rounds up to the next 15-min block)
 */
function getNext15MinTimestamp(): Date {
  const now = new Date();
  const minutes = now.getMinutes();
  const nextQuarter = Math.ceil(minutes / 15) * 15;
  const next = new Date(now);
  next.setMinutes(nextQuarter, 0, 0);
  if (nextQuarter >= 60) {
    next.setHours(next.getHours() + 1);
    next.setMinutes(0);
  }
  return next;
}

/**
 * Format a date to a human-readable string
 */
function formatNextMarketTime(date: Date): string {
  return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
}

const BettingBotTerminal = () => {
  const [selectedAsset, setSelectedAsset] = useState<SupportedAsset>("BTC");
  const [selectedPrice, setSelectedPrice] = useState<number>(48);
  const [orderSize, setOrderSize] = useState<number>(25);
  const [isDropdownOpen, setIsDropdownOpen] = useState(false);
  const [isPriceDropdownOpen, setIsPriceDropdownOpen] = useState(false);
  const [isBotRunning, setIsBotRunning] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [logs, setLogs] = useState<BotLogEntry[]>([]);
  const [error, setError] = useState<string | null>(null);
  const dropdownRef = useRef<HTMLDivElement>(null);
  const priceDropdownRef = useRef<HTMLDivElement>(null);
  const logsEndRef = useRef<HTMLDivElement>(null);
  const pollIntervalRef = useRef<NodeJS.Timeout | null>(null);

  // Close dropdowns when clicking outside
  useEffect(() => {
    const handleClickOutside = (event: MouseEvent) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {
        setIsDropdownOpen(false);
      }
      if (priceDropdownRef.current && !priceDropdownRef.current.contains(event.target as Node)) {
        setIsPriceDropdownOpen(false);
      }
    };
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, []);

  // Auto-scroll logs to bottom
  useEffect(() => {
    logsEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [logs]);

  // Cleanup interval on unmount
  useEffect(() => {
    return () => {
      if (pollIntervalRef.current) {
        clearInterval(pollIntervalRef.current);
      }
    };
  }, []);

  // Add local log entry
  const addLog = useCallback((level: BotLogEntry["level"], message: string, details?: Record<string, unknown>) => {
    setLogs(prev => [...prev, {
      timestamp: new Date().toISOString(),
      level,
      message,
      details,
    }]);
  }, []);

  // Submit a single order to the limit order bot
  const submitOrder = useCallback(async () => {
    setIsSubmitting(true);
    setError(null);

    try {
      const response = await fetch("/api/limit-order-bot", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          asset: selectedAsset,
          price: selectedPrice,
          sizeUsd: orderSize,
        }),
      });

      const data: LimitOrderBotResponse = await response.json();

      if (!data.success) {
        setError(data.error || "Order submission failed");
        addLog("ERROR", data.error || "Order submission failed");
        // Still show next market time after error (15 minutes after current)
        const nextMarketStart = new Date(getNext15MinTimestamp().getTime() + 15 * 60 * 1000);
        const nextMarketEnd = new Date(nextMarketStart.getTime() + 15 * 60 * 1000);
        addLog("INFO", `Next Market Up: ${selectedAsset} Market ${formatNextMarketTime(nextMarketStart)} -- ${formatNextMarketTime(nextMarketEnd)}`);
        return;
      }

      // Log market result with Polymarket URL and order status
      if (data.data?.market) {
        const market = data.data.market;
        const asset = data.data.asset;
        const sizeUsd = data.data.sizeUsd;
        const polymarketUrl = `https://polymarket.com/event/${market.marketSlug}`;
        
        // Calculate market start and end times from the timestamp
        const marketStartTime = new Date(market.targetTimestamp * 1000);
        const marketEndTime = new Date(marketStartTime.getTime() + 15 * 60 * 1000);
        const startTimeStr = formatNextMarketTime(marketStartTime);
        const endTimeStr = formatNextMarketTime(marketEndTime);
        
        if (market.error) {
          addLog("ERROR", `${asset} Market ${startTimeStr} -- ${endTimeStr}: ${polymarketUrl} — Failed: ${market.error}`);
        } else {
          const upStatus = market.ordersPlaced?.up?.success ? "✓" : "✗";
          const downStatus = market.ordersPlaced?.down?.success ? "✓" : "✗";
          addLog("SUCCESS", `${asset} Market ${startTimeStr} -- ${endTimeStr}: ${polymarketUrl} Up: ${upStatus} Down: ${downStatus} $${sizeUsd}`);
        }
        
        // Log the next market time (15 minutes after the one we just placed orders for)
        const nextMarketStart = new Date(marketStartTime.getTime() + 15 * 60 * 1000);
        const nextMarketEnd = new Date(nextMarketStart.getTime() + 15 * 60 * 1000);
        addLog("INFO", `Next Market Up: ${asset} Market ${formatNextMarketTime(nextMarketStart)} -- ${formatNextMarketTime(nextMarketEnd)}`);
      }

    } catch (err) {
      const errorMsg = err instanceof Error ? err.message : "Network error";
      setError(errorMsg);
      addLog("ERROR", `Submission failed: ${errorMsg}`);
    } finally {
      setIsSubmitting(false);
    }
  }, [selectedAsset, selectedPrice, orderSize, addLog]);

  // Start the bot with polling
  const startBot = useCallback(() => {
    setIsBotRunning(true);
    setError(null);
    addLog("INFO", `Bot started — ${selectedAsset} at ${selectedPrice}% with $${orderSize} total`);
    
    // Submit immediately
    submitOrder();
    
    // Set up 15-minute polling
    pollIntervalRef.current = setInterval(() => {
      submitOrder();
    }, POLL_INTERVAL_MS);
  }, [selectedAsset, selectedPrice, orderSize, addLog, submitOrder]);

  // Stop the bot
  const stopBot = useCallback(() => {
    if (pollIntervalRef.current) {
      clearInterval(pollIntervalRef.current);
      pollIntervalRef.current = null;
    }
    setIsBotRunning(false);
    addLog("INFO", "Bot stopped");
  }, [addLog]);

  // Get log level styling
  const getLogLevelStyle = (level: BotLogEntry["level"]) => {
    switch (level) {
      case "SUCCESS":
        return "text-success";
      case "ERROR":
        return "text-destructive";
      case "WARN":
        return "text-warning";
      default:
        return "text-muted-foreground";
    }
  };

  const getLogLevelIcon = (level: BotLogEntry["level"]) => {
    switch (level) {
      case "SUCCESS":
        return "✓";
      case "ERROR":
        return "✗";
      case "WARN":
        return "⚠";
      default:
        return "›";
    }
  };

  const selectedAssetData = ASSETS.find(a => a.value === selectedAsset);

  return (
    <div className="min-h-[calc(100vh-80px)] px-2 py-4 md:px-4 md:py-6">
      <div className="max-w-4xl mx-auto">
        <div className="space-y-6">
          {/* Header */}
          <div className="text-center py-8 fade-in">
            <div className="relative mb-8">
              <h2 className="font-display text-xl md:text-2xl font-bold text-primary text-glow mb-1">
                Polymarket 15 Minute Up/Down Arbitrage Bot
              </h2>
              <p className="text-xs text-muted-foreground/60 mb-3">(more bots coming soon)</p>
              <p className="text-muted-foreground max-w-lg mx-auto">
                Automatically place straddle limit orders on Polymarket 15-minute Up/Down markets every 15 minutes.
              </p>
            </div>
          </div>

          {/* How It Works Section */}
          <div className="border border-border/50 rounded-lg bg-secondary/30 p-4">
            <h3 className="font-display text-sm font-semibold text-primary mb-2">
              How It Works
            </h3>
            <ul className="text-sm text-muted-foreground space-y-1">
              <li className="flex items-start gap-2">
                <span className="text-primary">1.</span>
                <span>Select your preferred market type (BTC, ETH, SOL, or XRP) for 15-minute Up/Down markets</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary">2.</span>
                <span>Set your order price (48% recommended for straddle) and total USD amount per side -- note that total shares cannot be below 5 on Polymarket, hence the minimum order size is $3.</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary">3.</span>
                <span>Click "Start Bot" to begin — the bot will place limit orders on the next market immediately</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary">4.</span>
                <span>The bot automatically runs every 15 minutes to place orders on each new market</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="text-primary">5.</span>
                <span>Click "Stop Bot" to pause the bot at any time</span>
              </li>
            </ul>
          </div>

          {/* Why It Works Section */}
          <div className="border border-border/50 rounded-lg bg-secondary/30 p-4">
            <div className="flex items-center gap-2 mb-3">
              <h3 className="font-display text-sm font-semibold text-primary">
                Why It Works: 
              </h3>
              <a 
                href="https://x.com/hanakoxbt/status/1999149407955308699?s=20" 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-xs text-muted-foreground/60 hover:text-primary transition-colors underline underline-offset-2 font-mono truncate max-w-[200px] sm:max-w-none"
              >
                x.com/hanakoxbt/status/1999149407955308699
              </a>
            </div>
            <div className="text-sm text-muted-foreground space-y-3">
              <p>
                This strategy exploits a simple arbitrage opportunity in binary prediction markets:
              </p>
              <div className="bg-card/50 rounded-lg p-3 space-y-2 font-mono text-xs border border-border/30">
                <div className="flex items-center gap-2">
                  <span className="text-primary">→</span>
                  <span>Find a 15m crypto market with high liquidity</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-primary">→</span>
                  <span>Place limit orders: buy "Yes" at $0.48 and "No" at $0.48</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-primary">→</span>
                  <span>Wait until both orders are filled</span>
                </div>
                <div className="flex items-center gap-2">
                  <span className="text-primary">→</span>
                  <span>Total cost: <span className="text-warning">$0.96</span> for shares on both sides</span>
                </div>
              </div>
              <p>
                <span className="text-success font-semibold">Regardless of the outcome</span>, one side always pays out $1.00 — guaranteeing a <span className="text-success font-semibold">~4% profit</span> per trade when both orders fill.
              </p>
            </div>
          </div>

          {/* Controls Card */}
          <div className="relative z-20 border border-border rounded-lg bg-card/80 backdrop-blur-sm border-glow">
            <div className="flex items-center justify-between px-4 py-2 border-b border-border/50">
              <div className="flex items-center gap-2">
                <Bot className="w-4 h-4 text-primary" />
                <span className="text-xs text-muted-foreground font-display">
                  BOT CONFIGURATION
                </span>
              </div>
              {isBotRunning && (
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse" />
                  <span className="text-xs text-green-500 font-mono">RUNNING</span>
                </div>
              )}
            </div>

            <div className="p-4 space-y-4">
              {/* Asset Selection Row */}
              <div className="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                <label className="text-sm font-medium text-muted-foreground min-w-[120px]">
                  Market Type:
                </label>
                
                {/* Asset Dropdown */}
                <div className="relative flex-1 max-w-xs" ref={dropdownRef}>
                  <button
                    type="button"
                    onClick={() => !isBotRunning && setIsDropdownOpen(!isDropdownOpen)}
                    disabled={isBotRunning}
                    className="w-full flex items-center justify-between gap-2 px-4 py-3 rounded-lg bg-secondary/50 border border-border text-sm hover:border-primary/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <div className="flex items-center gap-3">
                      <span className="text-xl">{selectedAssetData?.icon}</span>
                      <span className="font-mono">{selectedAssetData?.label}</span>
                    </div>
                    <ChevronDown className={`w-4 h-4 transition-transform ${isDropdownOpen ? "rotate-180" : ""}`} />
                  </button>

                  {isDropdownOpen && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-card border border-border rounded-lg shadow-xl z-[100] overflow-hidden">
                      {ASSETS.map((asset) => (
                        <button
                          key={asset.value}
                          type="button"
                          onClick={() => {
                            setSelectedAsset(asset.value);
                            setIsDropdownOpen(false);
                          }}
                          className={`w-full flex items-center gap-3 px-4 py-3 text-left transition-colors ${
                            selectedAsset === asset.value
                              ? "bg-primary/20 text-primary"
                              : "hover:bg-secondary text-foreground"
                          }`}
                        >
                          <span className="text-xl">{asset.icon}</span>
                          <span className="font-mono">{asset.label}</span>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Price Selection Row */}
              <div className="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                <label className="text-sm font-medium text-muted-foreground min-w-[120px]">
                  Order Price:
                </label>
                
                {/* Price Dropdown */}
                <div className="relative flex-1 max-w-xs" ref={priceDropdownRef}>
                  <button
                    type="button"
                    onClick={() => !isBotRunning && setIsPriceDropdownOpen(!isPriceDropdownOpen)}
                    disabled={isBotRunning}
                    className="w-full flex items-center justify-between gap-2 px-4 py-3 rounded-lg bg-secondary/50 border border-border text-sm hover:border-primary/50 transition-all disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <div className="flex items-center gap-3">
                      <Percent className="w-4 h-4 text-primary" />
                      <span className="font-mono">{selectedPrice}%{selectedPrice === 48 && " (Recommended)"}</span>
                    </div>
                    <ChevronDown className={`w-4 h-4 transition-transform ${isPriceDropdownOpen ? "rotate-180" : ""}`} />
                  </button>

                  {isPriceDropdownOpen && (
                    <div className="absolute top-full left-0 right-0 mt-1 bg-card border border-border rounded-lg shadow-xl z-[100] overflow-hidden max-h-[250px] overflow-y-auto">
                      {PRICE_OPTIONS.map((option) => (
                        <button
                          key={option.value}
                          type="button"
                          onClick={() => {
                            setSelectedPrice(option.value);
                            setIsPriceDropdownOpen(false);
                          }}
                          className={`w-full flex items-center gap-3 px-4 py-3 text-left transition-colors ${
                            selectedPrice === option.value
                              ? "bg-primary/20 text-primary"
                              : "hover:bg-secondary text-foreground"
                          }`}
                        >
                          <span className="font-mono">{option.label}</span>
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              {/* Order Size Row */}
              <div className="flex flex-col sm:flex-row items-start sm:items-center gap-4">
                <label className="text-sm font-medium text-muted-foreground min-w-[120px]">
                  Order Size:
                </label>
                
                {/* Order Size Input */}
                <div className="relative flex-1 max-w-xs">
                  <div className="flex items-center gap-2 px-4 py-3 rounded-lg bg-secondary/50 border border-border text-sm">
                    <DollarSign className="w-4 h-4 text-primary" />
                    <input
                      type="number"
                      value={orderSize}
                      onChange={(e) => setOrderSize(Math.max(3, parseInt(e.target.value) || 3))}
                      disabled={isBotRunning}
                      min="3"
                      max="1000"
                      className="bg-transparent border-none outline-none font-mono w-20 disabled:opacity-50 disabled:cursor-not-allowed"
                    />
                    <span className="text-muted-foreground text-xs">USD per side</span>
                  </div>
                </div>
              </div>

              {/* Start/Stop Bot Button Row */}
              <div className="flex flex-wrap items-center gap-4 pt-2">
                {!isBotRunning ? (
                  <button
                    type="button"
                    onClick={startBot}
                    disabled={isSubmitting}
                    className="flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all bg-primary/20 border border-primary/50 text-primary hover:bg-primary/30 glow-box-hover disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Play className="w-4 h-4" />
                    <span>Start Bot</span>
                  </button>
                ) : (
                  <button
                    type="button"
                    onClick={stopBot}
                    className="flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all bg-destructive/20 border border-destructive/50 text-destructive hover:bg-destructive/30"
                  >
                    {isSubmitting ? (
                      <Loader2 className="w-4 h-4 animate-spin" />
                    ) : (
                      <Square className="w-4 h-4" />
                    )}
                    <span>Stop Bot</span>
                  </button>
                )}
              </div>
            </div>
          </div>

          {/* Error Display */}
          {error && (
            <div className="border border-destructive/50 rounded-lg bg-destructive/10 p-4 fade-in">
              <div className="flex items-center gap-2">
                <AlertTriangle className="w-4 h-4 text-destructive" />
                <p className="text-destructive text-sm font-mono">{error}</p>
              </div>
            </div>
          )}

          {/* Logs Output */}
          <div className="relative z-10 border border-border rounded-lg bg-card/80 backdrop-blur-sm">
            <div className="flex items-center justify-between px-4 py-2 border-b border-border/50">
              <div className="flex items-center gap-2">
                <div className={`w-2 h-2 rounded-full ${isBotRunning ? 'bg-green-500' : 'bg-primary'} animate-pulse`} />
                <span className="text-xs text-muted-foreground font-display">
                  BOT LOGS
                </span>
              </div>
              <button
                type="button"
                onClick={() => setLogs([])}
                className="text-xs text-muted-foreground hover:text-foreground transition-colors"
              >
                Clear
              </button>
            </div>

            <div className="h-[400px] overflow-y-auto p-4 font-mono text-sm">
              {logs.length === 0 ? (
                <div className="flex items-center justify-center h-full text-muted-foreground">
                  <span>No logs yet. Start the bot to begin.</span>
                </div>
              ) : (
                <div className="space-y-1">
                  {logs.map((log, index) => (
                    <div key={index} className="flex gap-2 leading-relaxed">
                      <span className="text-muted-foreground/60 text-xs whitespace-nowrap">
                        {new Date(log.timestamp).toLocaleTimeString()}
                      </span>
                      <span className={`${getLogLevelStyle(log.level)} w-4`}>
                        {getLogLevelIcon(log.level)}
                      </span>
                      <span className={getLogLevelStyle(log.level)}>
                        {log.message}
                      </span>
                      {log.details && (
                        <span className="text-muted-foreground/60 text-xs">
                          {JSON.stringify(log.details)}
                        </span>
                      )}
                    </div>
                  ))}
                  <div ref={logsEndRef} />
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default BettingBotTerminal;
